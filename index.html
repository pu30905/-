<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#fff">

<title>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#3b82f6;--ok:#16a34a;--bad:#ef4444;--line:#e5e7eb}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

/* 1. åŸºç¤å­—é«” 18px */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink); font-size: 18px;}

/* é›¢è¢å¹•é ‚ç«¯ 24px */
.wrap{max-width:1000px;margin:24px auto;padding:0 12px}

/* å¡ç‰‡å…§è·ï¼šä¸Š15px / ä¸‹10px */
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:15px 16px 10px 16px; position: relative;}

/* æ¨™é¡Œèˆ‡æ¨™é¡Œåˆ—çš„åˆ·æ–°æŒ‰éˆ• */
.title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
h1{margin:0;font-size:28px; line-height: 1.2;}
.sub{color:var(--muted);font-size:14px; font-weight: normal;}

/* âœ… æ–°å¢ï¼šæ¨™é¡Œæ—çš„é‡æ–°æ•´ç†æŒ‰éˆ• */
.btn-reload {
  background: #f1f5f9; border: 1px solid var(--line); color: var(--muted);
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; cursor: pointer; transition: 0.2s;
}
.btn-reload:active { background: #e2e8f0; transform: rotate(180deg); }

/* è¡Œé–“è· */
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

/* 2. å…ƒä»¶æ¨£å¼ */
button,select,input[type="text"]{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;color:var(--ink);font-size:18px;cursor:pointer; appearance: none; -webkit-appearance: none;}
input[type="text"]{cursor:text; width: 240px;}
/* ä¿®æ­£ iOS ä¸‹æ‹‰é¸å–®ç®­é ­æ¶ˆå¤±å•é¡Œ */
select {
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px;
  padding-right: 30px;
}

.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}.btn.ghost{background:#fff}

/* çµ±è¨ˆæ¨™ç±¤ */
.badge{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:6px 10px;font-size:18px;}

/* åˆ†éš”ç·š */
.hr{height:1px;background:var(--line);margin:10px 0}

/* 3. é¡Œç›®èˆ‡é¸é … */
.question{font-size:25px; line-height:1.4; margin:10px 0 12px; font-weight: normal; color: var(--ink);}
.opt{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:4px 0;font-size:21px;background:#fff;cursor:pointer}
.opt:hover{background:#f8fafc}
.opt.correct{border-color:var(--ok);background:#f0fdf4}.opt.wrong{border-color:var(--bad);background:#fef2f2}
.opt input { width: 21px; height: 21px; margin-top: 5px; cursor: pointer; flex-shrink: 0; }

.feedback{margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:18px;background:#f8fafc}
.feedback.ok{color:var(--ok)}.feedback.bad{color:var(--bad)}

.nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);background:#eef2ff;border-radius:999px;font-size:18px;cursor:pointer}
.chip input{width:18px;height:18px;cursor:pointer}

.report{margin-top:12px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:14px}
.hidden{display:none}

/* æ’ç‰ˆè¼”åŠ© */
.control-group { display: flex; gap: 8px; align-items: center; }
.ctrl-item { display: flex; align-items: center; gap: 6px; }
.btn-group { display: flex; gap: 8px; } 

/* 4. æ‰‹æ©Ÿç‰ˆå°ˆå±¬è¨­å®š */
@media(max-width:600px){
  h1{font-size:26px}
  .question{font-size:24px}
  .opt{font-size:20px}
  
  input[type="text"]{width:100%; font-size: 18px;}
  select { font-size: 18px; }
  
  .stats-row {
    display: grid !important;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 4px; 
    width: 100%;
  }
  .stats-row .badge {
    font-size: 15px;
    padding: 6px 2px;
    text-align: center;
    margin: 0;
    white-space: nowrap;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .control-group { width: 100%; display: flex; justify-content: space-between; gap: 6px; }
  .ctrl-item { flex: 1; flex-direction: row; align-items: center; justify-content: flex-start; }
  .ctrl-item label { font-size: 15px; white-space: nowrap; }
  .ctrl-item select { width: 100%; }

  .btn-group { width: 100%; margin-top: 6px; gap: 6px; }
  .s-start, .s-reset, .s-finish { padding: 10px 2px; font-size: 17px; flex: 1; white-space: nowrap; }
  .s-finish { flex: 1.2; letter-spacing: -0.5px; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title-row">
      <h1>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº <span class="sub">â€” é›²ç«¯ç‰ˆ</span></h1>
      <button class="btn-reload" onclick="forceReload()" title="æª¢æŸ¥æ›´æ–°">â†»</button>
    </div>
  </div>
  <div class="card" id="panel-student">è¼‰å…¥é¡Œåº«ä¸­...</div>
</div>

<script>
const $ = s => document.querySelector(s);
const isArray = Array.isArray;
function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

// âœ… å¼·åˆ¶åˆ·æ–°å‡½å¼
function forceReload() {
  if(confirm("ç¢ºå®šè¦é‡æ–°æ•´ç†ä¸¦æª¢æŸ¥æ›´æ–°å—ï¼Ÿ\n(å°‡æœƒæ¸…é™¤ç•¶å‰ä½œç­”é€²åº¦)")) {
    // å¼·åˆ¶å¾ä¼ºæœå™¨æŠ“å–ï¼Œä¸ä½¿ç”¨å¿«å–
    window.location.reload(true);
  }
}

let BANK = [];

async function init(){
  try {
    const r = await fetch('questions.json?t=' + new Date().getTime(), { cache: 'no-store' });
    if(!r.ok) throw new Error('è®€å–å¤±æ•—');
    BANK = await r.json();
    mountStudent('#panel-student');
  } catch(e) {
    $('#panel-student').innerHTML = `<p style="color:red">ç„¡æ³•è®€å–é¡Œåº«ï¼Œè«‹ç¢ºèª questions.json æ˜¯å¦å·²ä¸Šå‚³ã€‚</p>`;
  }
}

function mountStudent(selector){
  const el = $(selector);
  
  el.innerHTML=`
    <div class="row stats-row">
      <div class="badge"><b class="s-total">${BANK.length}</b> é¡Œ</div>
      <div class="badge">ç›®å‰ <b class="s-progress">0/0</b></div>
      <div class="badge">ç­”å° <b class="s-right">0</b></div>
    </div>
    
    <div class="hr"></div>

    <div class="row">
      <div style="font-size:18px;font-weight:bold">1. é¸æ“‡ç« ç¯€ï¼š</div>
      <div class="chips s-sections"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="font-size:18px;font-weight:bold">2. é—œéµå­—æœå°‹ï¼š</div>
      <input type="text" class="s-keyword" placeholder="è¼¸å…¥é—œéµå­— (é¡Œç›®æˆ–é¸é …)...">
    </div>

    <div class="hr"></div>

    <div class="row" style="flex-direction: column; align-items: stretch; gap: 8px;">
      
      <div class="control-group">
        <div class="ctrl-item">
          <label>æ¨¡å¼</label>
          <select class="s-mode"><option value="order">ä¾é †åº</option><option value="shuffle">éš¨æ©Ÿ</option></select>
        </div>
        <div class="ctrl-item">
          <label>é¡Œæ•¸</label>
          <select class="s-count">
            <option value="all" selected>å…¨éƒ¨</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn brand s-start">é–‹å§‹ä½œç­”</button>
        <button class="btn ghost s-reset">é‡ç½®</button>
        <button class="btn ghost s-finish" disabled>å®Œæˆä¸¦çœ‹æˆç¸¾</button>
      </div>

    </div>

    <div class="hr"></div>
    <div class="question s-q">è«‹é¸æ“‡æ¢ä»¶å¾Œï¼ŒæŒ‰ã€Œé–‹å§‹ä½œç­”ã€</div>
    <div class="s-optBox"></div>
    
    <div class="feedback s-fb hidden">
      <div class="s-fbTitle" style="font-weight:bold"></div>
      <div class="s-fbAns"></div>
      <div class="s-fbExp"></div>
    </div>
    
    <div class="nav hidden s-nav">
      <button class="btn s-prev">â† ä¸Šä¸€é¡Œ</button>
      <button class="btn s-next">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
    <div class="report hidden s-report"></div>
  `;
  
  const state = {paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}};
  el._state = state;
  
  const secs = [...new Set(BANK.map(q => q.section||'æœªåˆ†é¡'))];
  el.querySelector('.s-sections').innerHTML = secs.map(s => `
    <label class="chip"><input type="checkbox" value="${s}" checked> ${s}</label>
  `).join('');

  el.querySelector('.s-start').onclick = () => start(el);
  el.querySelector('.s-reset').onclick = () => mountStudent(selector); 
  el.querySelector('.s-prev').onclick = () => { if(state.idx>0){ state.idx--; render(el); } };
  el.querySelector('.s-next').onclick = () => { 
    if(state.idx < state.paper.length-1){ state.idx++; render(el); }
    else { showReport(el); }
  };
  el.querySelector('.s-finish').onclick = () => showReport(el);
}

function start(root){
  const st = root._state;
  const mode = root.querySelector('.s-mode').value;
  const wantStr = root.querySelector('.s-count').value;
  const keyword = root.querySelector('.s-keyword').value.trim().toLowerCase(); 
  const chosen = [...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value);
  
  if(!chosen.length) return alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç« ç¯€');
  
  let pool = BANK.map((q,i)=>({q,i})).filter(x => chosen.includes(x.q.section||'æœªåˆ†é¡'));

  // æœå°‹é‚è¼¯ï¼šé¡Œç›® + é¸é … (ä¸å«è§£æ)
  if(keyword) {
    pool = pool.filter(item => {
      const qText = (item.q.question || "").toLowerCase();
      const optsText = (item.q.options || []).join(" ").toLowerCase();
      return qText.includes(keyword) || optsText.includes(keyword);
    });
  }

  const poolIdx = pool.map(x=>x.i);

  if(!poolIdx.length) {
    if(keyword) return alert(`åœ¨é¸å®šçš„ç« ç¯€ä¸­ï¼Œæ‰¾ä¸åˆ°åŒ…å«ã€Œ${keyword}ã€çš„é¡Œç›®ã€‚`);
    return alert('æ‰€é¸ç« ç¯€ç›®å‰æ²’æœ‰é¡Œç›®');
  }
  
  let list = (mode==='shuffle') ? shuffle(poolIdx) : poolIdx;
  const want = (wantStr==='all') ? list.length : Math.min(parseInt(wantStr), list.length);
  
  st.paper = list.slice(0, want);
  st.idx = 0; st.right = 0; st.user = {}; st.revealed = {}; st.firstScored = {};
  
  root.querySelector('.s-finish').disabled = false;
  root.querySelector('.s-nav').classList.remove('hidden');
  render(root);
}

function render(root){
  const st = root._state;
  const pi = st.paper[st.idx];
  const q = BANK[pi];
  
  root.querySelector('.s-progress').textContent = `${st.idx+1}/${st.paper.length}`;
  root.querySelector('.s-right').textContent = st.right;
  root.querySelector('.s-q').textContent = q.question;
  
  const box = root.querySelector('.s-optBox');
  box.innerHTML = '';
  const correct = normalize(q.answer);
  const isMulti = correct.length > 1;
  const cur = normalize(st.user[pi]);
  
  (q.options||[]).forEach((opt, i) => {
    const row = document.createElement('label'); 
    row.className = 'opt';
    const ip = document.createElement('input'); 
    ip.type = isMulti ? 'checkbox' : 'radio';
    ip.name = 'q_opt';
    ip.checked = cur.includes(i);
    
    row.onclick = (e) => {
      if(e.target !== ip) ip.checked = !ip.checked;
      
      let now = new Set(normalize(st.user[pi]));
      if(isMulti){
        if(ip.checked) now.add(i); else now.delete(i);
      } else {
        now = new Set([i]);
        box.querySelectorAll('input').forEach((inp, idx) => { if(idx!==i) inp.checked=false; });
      }
      st.user[pi] = [...now].sort((a,b)=>a-b);
      
      const uAns = st.user[pi];
      const right = same(uAns, q.answer);
      if(!isMulti || uAns.length >= correct.length){
         st.revealed[pi] = true;
         if(right && !st.firstScored[pi]){ st.right++; st.firstScored[pi]=true; }
         refreshUI(root, q, pi);
      }
    };
    row.append(ip, document.createTextNode(" " + opt));
    box.append(row);
  });
  
  refreshUI(root, q, pi);
}

function refreshUI(root, q, pi){
  const st = root._state;
  const isRev = st.revealed[pi];
  const uAns = normalize(st.user[pi]);
  const correct = normalize(q.answer);
  const ok = same(uAns, q.answer);
  
  const fb = root.querySelector('.s-fb');
  if(isRev){
    fb.classList.remove('hidden');
    fb.className = `feedback s-fb ${ok?'ok':'bad'}`;
    
    root.querySelector('.s-fbTitle').textContent = ok ? 'ç­”å°äº† âœ…' : 'ç­”éŒ¯äº† âŒ';
    
    const ansText = correct.map(i => (q.options && q.options[i]) ? q.options[i] : ['A','B','C','D'][i]).join(', ');
    root.querySelector('.s-fbAns').textContent = 'æ­£ç¢ºç­”æ¡ˆï¼š' + ansText;
    
    root.querySelector('.s-fbExp').textContent = q.explanation ? 'è§£æï¼š' + q.explanation : '';
    
    root.querySelectorAll('.opt').forEach((row, i) => {
      row.classList.remove('correct','wrong');
      if(correct.includes(i)) row.classList.add('correct');
      else if(uAns.includes(i)) row.classList.add('wrong');
    });
  } else {
    fb.classList.add('hidden');
  }
}

function showReport(root){
  const st = root._state;
  const box = root.querySelector('.s-report');
  box.classList.remove('hidden');
  const wrongList = st.paper.filter(pi => !same(st.user[pi], BANK[pi].answer));
  
  box.innerHTML = `
    <h2 style="color:#3b82f6; margin-top:0">æœ¬æ¬¡ç·´ç¿’å·²å®Œæˆ</h2>
    <div style="margin-bottom:15px; font-size:18px;">
       <span class="chip">ç­”å°ï¼š${st.right} / ${st.paper.length}</span>
       <span class="chip">æ­£ç¢ºç‡ï¼š${st.paper.length > 0 ? Math.round(st.right/st.paper.length*100) : 0}%</span>
    </div>
    ${wrongList.length===0 ? '<p style="font-size:20px; color:#16a34a">å…¨å°ï¼å¤ªæ£’äº† ğŸ‰</p>' : 
      `<details open><summary>éŒ¯é¡Œæ¸…å–® (${wrongList.length})</summary>
       <ul>${wrongList.map(pi => {
         const q = BANK[pi];
         const ansText = normalize(q.answer).map(i => (q.options && q.options[i]) ? q.options[i] : ['A','B','C','D'][i]).join(', ');
         return `<li>
            <b>${q.question}</b><br>
            <span style="color:#16a34a">æ­£è§£ï¼š${ansText}</span><br>
            <span class="sub">è§£æï¼š${q.explanation||'ç„¡'}</span>
         </li>`;
       }).join('')}</ul></details>`
    }
    <div style="margin-top:20px">
       <button class="btn brand" onclick="mountStudent('#panel-student')">å†ç·´ç¿’ä¸€æ¬¡</button>
    </div>
  `;
  root.querySelector('.s-nav').classList.add('hidden');
  root.querySelector('.s-optBox').innerHTML = '';
  root.querySelector('.s-q').textContent = ''; 
}

init();

// âœ… è¨»å†Š Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(reg => console.log('SW registered!', reg))
    .catch(err => console.log('SW failed', err));
}
</script>
</body>
</html>
